INSERT INTO TBLLOGREGIST 
VALUES (seq_TBLLOGREGIST.NEXTVAL,(SELECT ID_SCRIPT FROM TBLLOGSCRIPT WHERE DESC_SCRIPT='PROMOCIONES_SAMPLINGS_PROCESO'),current_date,null,null,null,0);
COMMIT;

INSERT INTO TBLLOGREGEST SELECT MAX(ID_REGISTRO), 1 FROM TBLLOGREGIST WHERE ID_SCRIPT=(SELECT ID_SCRIPT FROM TBLLOGSCRIPT WHERE DESC_SCRIPT='PROMOCIONES_SAMPLINGS_PROCESO'); 
COMMIT;


 ---------------------------------------------------------------------------------------------------------------------
 ---------------------------------------------------------------------------------------------------------------------
 ---------------------------------------------------------------------------------------------------------------------
 ---------------------CARGA DE TABLAS DE HECHOS DE OBJETIVOS VENTAS COBERTURAS PROMOCIONES Y SAMPLINGS----------------
 ---------------------------------------------------------------------------------------------------------------------
 ---------------------------------------------------------------------------------------------------------------------
 ---------------------------------------------------------------------------------------------------------------------
 
 
 ---------------------------------------------------------------------------------------------------------------------
 ---------------------------------------------------------------------------------------------------------------------
 ---------------------------------------CARGA DE DIMENSIONES----------------------------------------------------------
 
 UPDATE MKT_ST_PS_FILTRO_ID SET UO=SUBSTR(ID,11,4) WHERE TIPO_ENTRADA='ID';
 COMMIT;
  
 UPDATE MKT_ST_PS_OBJETIVO SET TM_CATEGORIA='#' WHERE TM_CATEGORIA IS NULL;
 UPDATE MKT_ST_PS_OBJETIVO SET TM_EMPAQUE='#' WHERE TM_EMPAQUE IS NULL;
 UPDATE MKT_ST_PS_OBJETIVO SET TM_RETORNABILIDAD='#' WHERE TM_RETORNABILIDAD IS NULL;
 UPDATE MKT_ST_PS_OBJETIVO SET TM_TAMANO='#' WHERE TM_TAMANO IS NULL;
 UPDATE MKT_ST_PS_OBJETIVO SET CANAL='#' WHERE CANAL IS NULL;
 UPDATE MKT_ST_PS_OBJETIVO SET CLAVE_PROMOCION='#' WHERE CLAVE_PROMOCION IS NULL;
 UPDATE MKT_ST_PS_FILTRO_ID SET CLAVE_PROMOCION='#' WHERE CLAVE_PROMOCION IS NULL;
 COMMIT;
 
 
 --SELECT * FROM MKT_ST_PS_FILTRO_ID;
 --alter table MKT_ST_PS_FILTRO_ID ADD "UO" Nvarchar2(10);
 --alter table MKT_ST_PS_FILTRO_ID DROP COLUMN "OU";
 
--  SELECT * FROM MKT_ST_PS_OBJETIVO@DSE;
--  SELECT * FROM MKT_ST_PS_FILTRO_ID@DSE;
--  SELECT * FROM MKT_ST_PS_RUTA_CANAL@DSE;
--  
--  TRUNCATE TABLE MKT_ST_PS_FILTRO_ID@DSE;
--  
--  INSERT INTO MKT_ST_PS_FILTRO_ID@DSE (SELECT * FROM MKT_ST_PS_FILTRO_ID);
-- 
--  INSERT INTO MKT_ST_PS_OBJETIVO@DSE(SELECT * FROM MKT_ST_PS_OBJETIVO);
--  INSERT INTO MKT_ST_PS_RUTA_CANAL@DSE(SELECT * FROM MKT_ST_PS_RUTA_CANAL);
--  
--  SELECT SUBSTR(ID,11,4),ID FROM MKT_ST_PS_FILTRO_ID;
--  
--   INSERT INTO MKT_ST_PS_FILTRO_ID@DSE(
--  SELECT CLAVE_PROMOCION,
--   NOMBRE_PROMOCION,
--   TIPO_ENTRADA,
--   ID,
--   CF,
--   PIEZAS,
--   FECHA_INICIO,
--   FECHA_FIN,
--   SUBSTR(ID,11,4)AS UO
-- FROM MKT_ST_PS_FILTRO_ID );
-- 
-- COMMIT;

  -- DIMENSION PROMOCION
 
DROP SEQUENCE MKT_PS_SEQ_PROMOCION;  
--DROP SEQUENCE MKT_PS_SEQ_TIPO_PROMOCION;  
DROP SEQUENCE MKT_PS_SEQ_MKT_CANAL;

DROP SEQUENCE MKT_PS_SEQ_ALMACEN;
DROP SEQUENCE MKT_PS_SEQ_USUARIO;
DROP SEQUENCE MKT_PS_SEQ_MATERIAL;
DROP SEQUENCE MKT_PS_SEQ_REFERENCIA;
DROP SEQUENCE MKT_PS_SEQ_PEDIDO;
DROP SEQUENCE MKT_PS_SEQ_DOC_MATERIAL;
DROP SEQUENCE MKT_PS_SEQ_MB51;
DROP SEQUENCE MKT_PS_SEQ_MB58;

COMMIT;

----------------------------------------------------------


-- CARG DE DIMENSION PROMOCION

CREATE SEQUENCE MKT_PS_SEQ_PROMOCION
MINVALUE 1
START WITH 1
INCREMENT BY 1;
 
 
 INSERT INTO MKT_PS_DIM_PROMOCION
 SELECT MKT_PS_SEQ_PROMOCION.NEXTVAL,NOMBRE_PROMOCION FROM(
 SELECT NOMBRE_PROMOCION FROM MKT_ST_PS_OBJETIVO
 UNION
 SELECT NOMBRE_PROMOCION FROM MKT_ST_PS_FILTRO_ID);
 
 COMMIT;
 
 -----------------------------------------------------------------------
 -- CARGA DE DIMENSION TIPO PROMOCION
 
 INSERT INTO MKT_PS_DIM_TIPO_PROMOCION
 SELECT DISTINCT CLAVE_PROMOCION FROM(
 SELECT CLAVE_PROMOCION FROM MKT_ST_PS_OBJETIVO
 UNION
 SELECT CLAVE_PROMOCION FROM MKT_ST_PS_FILTRO_ID);
 
 COMMIT;
  -----------------------------------------------------------------------------------
 ---- CARGA DE DIMENSION CANAL MKT
 
 
  
  
CREATE SEQUENCE MKT_PS_SEQ_MKT_CANAL
MINVALUE 1
START WITH 1
INCREMENT BY 1;

INSERT INTO MKT_PS_DIM_CANAL_MKT
SELECT MKT_PS_SEQ_MKT_CANAL.NEXTVAL, CANAL_MKT, RUTA_REPARTO FROM(
SELECT DISTINCT RUTA_REPARTO, CANAL_MKT  FROM MKT_ST_PS_RUTA_CANAL);

COMMIT;
--------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------TABLAS DE HECHOS SKU VENTAS----------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------

-- TABLA TEMPORAL DE FILTRO ID
CREATE TABLE MKT_PS_TEMP_ID_FILTRO AS(
SELECT DISTINCT A.CLAVE_PROMOCION AS CLAVE_PROMOCION,
  P.PK_PROMOCION AS FK_PROMOCION,
  A.TIPO_ENTRADA,
  A.ID AS ID,
  A.CF,
  A.PIEZAS,
  TO_CHAR(A.FECHA_INICIO, 'YYYY-MM-DD') AS FECHA_INICIO,
  TO_CHAR(A.FECHA_FIN, 'YYYY-MM-DD') AS FECHA_FIN,
  A.UO
FROM MKT_ST_PS_FILTRO_ID A, MKT_PS_DIM_PROMOCION P
WHERE P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND A.TIPO_ENTRADA='ID'
UNION
SELECT DISTINCT A.CLAVE_PROMOCION AS CLAVE_PROMOCION,
  P.PK_PROMOCION AS FK_PROMOCION,
  A.TIPO_ENTRADA,
  LPAD(A.ID,18,'0') AS ID,
  A.CF,
  A.PIEZAS,
  TO_CHAR(A.FECHA_INICIO, 'YYYY-MM-DD') AS FECHA_INICIO,
  TO_CHAR(A.FECHA_FIN, 'YYYY-MM-DD') AS FECHA_FIN,
  A.UO
FROM MKT_ST_PS_FILTRO_ID A, MKT_PS_DIM_PROMOCION P
WHERE P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND A.TIPO_ENTRADA='SKU');
COMMIT;

-- FACT TABLE 

--MOD
INSERT INTO MKT_PS_FACT_VTA_SKU
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
--G.CENTRO AS FK_CENTRO,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
NVL(A.CLAVE_PROMOCION,'#') AS CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0'),
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  TO_NUMBER(NULL) AS CF_CONV,
  TO_NUMBER(NULL) AS PIEZAS_CONV,
  TO_NUMBER(NULL) AS CF_REAL,
  A.GEN_1,
  A.GEN_2,
  A.GEN_3,
  A.GEN_4,
  A.GEN_5,
  A.GEN_6,
  A.GEN_7,
  A.GEN_8,
  A.GEN_9,
  A.GEN_10
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
AND A.TM_TPV IS NULL
;

COMMIT;
--SELECT * FROM MKT_ST_PS_OBJETIVO;

--- UPDATE DE FACT TABLE PARA REGISTRO DE VALORES DE CONVERSION

UPDATE MKT_PS_FACT_VTA_SKU A SET 
MD_CF_CONV=
(SELECT CF FROM MKT_PS_TEMP_ID_FILTRO F, MKT_PS_FACT_VTA_SKU A
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION
AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN AND
F.ID=A.FK_SKU),
MD_PIEZAS_CONV=
(SELECT PIEZAS FROM MKT_PS_TEMP_ID_FILTRO F
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION AND
F.ID=A.FK_SKU AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN);
 
 COMMIT;
 
--- TABLA AGREGADA POR REGION ZONA 

INSERT INTO MKT_PS_AGG_VTA_SKU_REG
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
NVL(A.CLAVE_PROMOCION,'#'),
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0'),
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  TO_NUMBER(NULL) AS CF_CONV,
  TO_NUMBER(NULL) AS PIEZAS_CONV,
  TO_NUMBER(NULL) AS CF_REAL,
  A.GEN_1,
  A.GEN_2,
  A.GEN_3,
  A.GEN_4,
  A.GEN_5,
  A.GEN_6,
  A.GEN_7,
  A.GEN_8,
  A.GEN_9,
  A.GEN_10
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE
AND A.TM_TPV IS NULL
;




--- AGREGANDO VALORES A NIVEL ZONA

-- detectando llaves para agregacion 
CREATE TABLE MKT_PS_TEMP_5 AS(
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_FACT_VTA_SKU
MINUS
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_VTA_SKU_REG)
;
COMMIT;


---insertando registros agregados

INSERT INTO MKT_PS_AGG_VTA_SKU_REG
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_REGION,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_SKU,
  SUM(MD_CF_OBJ),
  SUM(MD_CFC_OBJ),
  SUM(MD_CU_OBJ),
  SUM(MD_PIEZAS_OBJ),
  SUM(MD_REDENCION),
  SUM(MD_DESCUENTO),
  SUM(MD_CF_CONV),
  SUM(MD_PIEZAS_CONV),
  SUM(MD_CF_REAL),
  SUM(MD_GENERICO_1),
  SUM(MD_GENERICO_2),
  SUM(MD_GENERICO_3),
  SUM(MD_GENERICO_4),
  SUM(MD_GENERICO_5),
  SUM(MD_GENERICO_6),
  SUM(MD_GENERICO_7),
  SUM(MD_GENERICO_8),
  SUM(MD_GENERICO_9),
  SUM(MD_GENERICO_10)
FROM MKT_PS_FACT_VTA_SKU F, MKT_PS_TEMP_5 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_REGION=T.FK_REGION AND 
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_SKU=T.FK_SKU group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_REGION, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO,
F.FK_CLAVE_PROMO, F.FK_PROMOCION,  F.FK_SKU;




--- UPDATE DE FACT TABLE PARA REGISTRO DE VALORES DE CONVERSION

UPDATE MKT_PS_AGG_VTA_SKU_REG A SET 
MD_CF_CONV=
(SELECT CF FROM MKT_PS_TEMP_ID_FILTRO F, MKT_PS_AGG_VTA_SKU_REG A
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION
AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN AND
F.ID=A.FK_SKU),
MD_PIEZAS_CONV=
(SELECT PIEZAS FROM MKT_PS_TEMP_ID_FILTRO F
WHERE F.CLAVE_PROMOCION=A.FK_CLAVE_PROMO AND
NVL(F.FK_PROMOCION,'#')=NVL(A.FK_PROMOCION,'#') AND
F.ID=A.FK_SKU AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN);
COMMIT;
--------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
--- TABLA AGREGADA POR ESTADO


INSERT INTO MKT_PS_AGG_VTA_SKU_EDO
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
NVL(A.CLAVE_PROMOCION,'#'),
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0'),
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  TO_NUMBER(NULL) AS CF_CONV,
  TO_NUMBER(NULL) AS PIEZAS_CONV,
  TO_NUMBER(NULL) AS CF_REAL,
  A.GEN_1,
  A.GEN_2,
  A.GEN_3,
  A.GEN_4,
  A.GEN_5,
  A.GEN_6,
  A.GEN_7,
  A.GEN_8,
  A.GEN_9,
  A.GEN_10
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE
AND A.TM_TPV IS NULL;

COMMIT;



--- AGREGANDO VALORES A NIVEL EDO

-- detectando llaves para agregacion 


CREATE TABLE MKT_PS_TEMP_6 AS(
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_VTA_SKU_REG
MINUS
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_VTA_SKU_EDO)
;
COMMIT;


---insertando registros agregados

INSERT INTO MKT_PS_AGG_VTA_SKU_EDO
SELECT DISTINCT
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_SKU,
  SUM(MD_CF_OBJ),
  SUM(MD_CFC_OBJ),
  SUM(MD_CU_OBJ),
  SUM(MD_PIEZAS_OBJ),
  SUM(MD_REDENCION),
  SUM(MD_DESCUENTO),
  SUM(MD_CF_CONV),
  SUM(MD_PIEZAS_CONV),
  SUM(MD_CF_REAL),
  SUM(MD_GENERICO_1),
  SUM(MD_GENERICO_2),
  SUM(MD_GENERICO_3),
  SUM(MD_GENERICO_4),
  SUM(MD_GENERICO_5),
  SUM(MD_GENERICO_6),
  SUM(MD_GENERICO_7),
  SUM(MD_GENERICO_8),
  SUM(MD_GENERICO_9),
  SUM(MD_GENERICO_10)
FROM MKT_PS_AGG_VTA_SKU_REG F, MKT_PS_TEMP_6 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_SKU=T.FK_SKU group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_CANAL_RM1,
F.FK_RETORNABILIDAD, F.FK_CATEGORIA, F.FK_TAMANO, F.FK_EMPAQUE, F.FK_PROMOCION, 
F.FK_CLAVE_PROMO, F.FK_SKU;

COMMIT;

-- UPDATE DE FACT TABLE PARA REGISTRO DE VALORES DE CONVERSION

UPDATE MKT_PS_AGG_VTA_SKU_EDO A SET 
MD_CF_CONV=
(SELECT CF FROM MKT_PS_TEMP_ID_FILTRO F, MKT_PS_AGG_VTA_SKU_EDO A
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION
AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN AND
F.ID=A.FK_SKU),
MD_PIEZAS_CONV=
(SELECT PIEZAS FROM MKT_PS_TEMP_ID_FILTRO F
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION AND
F.ID=A.FK_SKU AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN)
;
COMMIT;


-----------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------
---------------------------------------TABLAS DE HECHOS SKU VENTA PLAN DE VISITA  -------------------------------
-----------------------------------------------------------------------------------------------------------------


-- FACT TABLE 


INSERT INTO MKT_PS_FACT_VTA_SKU_PV
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
A.TM_TPV AS FK_PLAN_VISITA,
NVL(A.CLAVE_PROMOCION,'#'),
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0'),
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  TO_NUMBER(NULL) AS CF_CONV,
  TO_NUMBER(NULL) AS PIEZAS_CONV,
  TO_NUMBER(NULL) AS CF_REAL
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
AND A.TM_TPV IS NOT NULL
;

COMMIT;


--- UPDATE DE FACT TABLE PARA REGISTRO DE VALORES DE CONVERSION

UPDATE MKT_PS_FACT_VTA_SKU_PV A SET 
MD_CF_CONV=
(SELECT CF FROM MKT_PS_TEMP_ID_FILTRO F, MKT_PS_FACT_VTA_SKU_PV A
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION
AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN AND
F.ID=A.FK_SKU),
MD_PIEZAS_CONV=
(SELECT PIEZAS FROM MKT_PS_TEMP_ID_FILTRO F
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION AND
F.ID=A.FK_SKU AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN)
;
 COMMIT;
 
 
--- TABLA AGREGADA POR REGION ZONA 
--TRUNCATE TABLE MKT_PS_AGG_VTA_SKU_PV_REG;
INSERT INTO MKT_PS_AGG_VTA_SKU_PV_REG
SELECT 
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
A.TM_TPV AS FK_PLAN_VISITA,
NVL(A.CLAVE_PROMOCION,'#'),
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0'),
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  TO_NUMBER(NULL) AS CF_CONV,
  TO_NUMBER(NULL) AS PIEZAS_CONV,
  TO_NUMBER(NULL) AS CF_REAL
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE
AND A.TM_TPV IS NOT NULL
;





--- AGREGANDO VALORES A NIVEL ZONA

-- detectando llaves para agregacion 
CREATE TABLE MKT_PS_TEMP_7 AS(
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_FACT_VTA_SKU_PV
MINUS
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_VTA_SKU_PV_REG)
;
COMMIT;


---insertando registros agregados

INSERT INTO MKT_PS_AGG_VTA_SKU_PV_REG
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_REGION,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PLAN_VISITA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_SKU,
  SUM(MD_CF_OBJ),
  SUM(MD_CFC_OBJ),
  SUM(MD_CU_OBJ),
  SUM(MD_PIEZAS_OBJ),
  SUM(MD_REDENCION),
  SUM(MD_DESCUENTO),
  SUM(MD_CF_CONV),
  SUM(MD_PIEZAS_CONV),
  SUM(MD_CF_REAL)
 FROM MKT_PS_FACT_VTA_SKU_PV F, MKT_PS_TEMP_7 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_REGION=T.FK_REGION AND 
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_PLAN_VISITA=T.FK_PLAN_VISITA AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_SKU=T.FK_SKU group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_REGION, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_CLAVE_PROMO, 
F.FK_PLAN_VISITA, F.FK_PLAN_VISITA, F.FK_SKU, F.FK_PROMOCION;

commit;


--- UPDATE DE FACT TABLE PARA REGISTRO DE VALORES DE CONVERSION

UPDATE MKT_PS_AGG_VTA_SKU_PV_REG A SET 
MD_CF_CONV=
(SELECT CF FROM MKT_PS_TEMP_ID_FILTRO F, MKT_PS_AGG_VTA_SKU_PV_REG A
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION
AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN AND
F.ID=A.FK_SKU),
MD_PIEZAS_CONV=
(SELECT PIEZAS FROM MKT_PS_TEMP_ID_FILTRO F
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION AND
F.ID=A.FK_SKU AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN)
;
COMMIT;
--------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
--- TABLA AGREGADA POR ESTADO

INSERT INTO MKT_PS_AGG_VTA_SKU_PV_EDO
SELECT 
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
A.TM_TPV AS FK_PLAN_VISITA,
NVL(A.CLAVE_PROMOCION,'#'),
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0'),
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  TO_NUMBER(NULL) AS CF_CONV,
  TO_NUMBER(NULL) AS PIEZAS_CONV,
  TO_NUMBER(NULL) AS CF_REAL
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE
AND A.TM_TPV IS NOT NULL
;




--- AGREGANDO VALORES A NIVEL ESTADO

-- detectando llaves para agregacion 
CREATE TABLE MKT_PS_TEMP_8 AS(
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_VTA_SKU_PV_REG
MINUS
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_VTA_SKU_PV_EDO)
;
COMMIT;


---insertando registros agregados

INSERT INTO MKT_PS_AGG_VTA_SKU_PV_EDO
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PLAN_VISITA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_SKU,
  SUM(MD_CF_OBJ),
  SUM(MD_CFC_OBJ),
  SUM(MD_CU_OBJ),
  SUM(MD_PIEZAS_OBJ),
  SUM(MD_REDENCION),
  SUM(MD_DESCUENTO),
  SUM(MD_CF_CONV),
  SUM(MD_PIEZAS_CONV),
  SUM(MD_CF_REAL)
 FROM MKT_PS_AGG_VTA_SKU_PV_REG F, MKT_PS_TEMP_8 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_PLAN_VISITA=T.FK_PLAN_VISITA AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_SKU=T.FK_SKU group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_CLAVE_PROMO, 
F.FK_PLAN_VISITA, F.FK_PLAN_VISITA, F.FK_SKU, F.FK_PROMOCION;


--- AGREGANDO VALORES A NIVEL ZONA

COMMIT;


--- UPDATE DE FACT TABLE PARA REGISTRO DE VALORES DE CONVERSION

UPDATE MKT_PS_AGG_VTA_SKU_PV_EDO A SET 
MD_CF_CONV=
(SELECT CF FROM MKT_PS_TEMP_ID_FILTRO F, MKT_PS_AGG_VTA_SKU_PV_EDO A
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION
AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN AND
F.ID=A.FK_SKU),
MD_PIEZAS_CONV=
(SELECT PIEZAS FROM MKT_PS_TEMP_ID_FILTRO F
WHERE NVL(F.CLAVE_PROMOCION,'#')=NVL(A.FK_CLAVE_PROMO,'#') AND
F.FK_PROMOCION=A.FK_PROMOCION AND
F.ID=A.FK_SKU AND F.FECHA_INICIO=A.FK_PERIODO_INICIO AND
F.FECHA_FIN=A.FK_PERIODO_FIN)
;
COMMIT;
 
 
 
 
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------TABLAS DE HECHOS VENTAS PEP---------------------------------------------- 
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------ 

--CREACION DE TABLA ELEMENTO PEP REGION
--DROP TABLE MKT_PS_ETL_PEP_PROMO;
CREATE TABLE MKT_PS_ETL_PEP_PROMO AS(
SELECT DISTINCT
  I.ID,
  P.C_PEP,
  NVL(O.CLAVE_PROMOCION,'#') AS CLAVE_PROMOCION,
  O.NOMBRE_PROMOCION,
  O.CORTE,
  O.CLAVE_CORTE,
  NVL(O.TM_CATEGORIA,'#') AS TM_CATEGORIA,
  NVL(O.TM_RETORNABILIDAD,'#') AS TM_RETORNABILIDAD,
  NVL(O.TM_EMPAQUE,'#') AS TM_EMPAQUE,
  NVL(O.TM_TAMANO,'#') AS TM_TAMANO,
  O.TM_TPV AS TM_TPV,
  O.FECHA_INICIO,
  O.FECHA_FIN,
  O.SKU_VENTA,
  NVL(O.CANAL,'#') AS CANAL,
  O.CF,
  O.CU,
  O.CFC,
  0 AS PIEZAS,
  0 AS C_ORO_TRA,
  0 AS C_PLATA_TRA,
  0 AS C_BRONCE_TRA,
  0 AS C_TRA,
  0 AS COB_ORO_TRA,
  0 AS COB_PLATA_TRA,
  0 AS COB_BRONCE_TRA,
  0 AS COB_TRA,
  0 AS C_ORO_ESP,
  0 AS C_PLATA_ESP,
  0 AS C_BRONCE_ESP,
  0 AS C_ESP,
  0 AS COB_ORO_ESP,
  0 AS COB_PLATA_ESP,
  0 AS COB_BRONCE_ESP,
  0 AS COB_ESP,
  0 AS REDENCION,
  0 AS DESCUENTOS,
  0 AS GEN_1,
  0 AS GEN_2,
  0 AS GEN_3,
  0 AS GEN_4,
  0 AS GEN_5,
  0 AS GEN_6,
  0 AS GEN_7,
  0 AS GEN_8,
  0 AS GEN_9,
  0 AS GEN_10,
  I.CF AS FC_CONV,
  I.PIEZAS AS PIEZAS_CONV
  FROM MKT_ST_PS_OBJETIVO O, MKT_ST_GEOGRAFIA_PEP P, MKT_ST_PS_FILTRO_ID I
  WHERE --O.CLAVE_CORTE IN ('MJCO','MJHE')
   I.TIPO_ENTRADA='ID'
  AND O.SKU_VENTA IS NULL
  AND P.C_CENTRO=O.CLAVE_CORTE
  AND P.C_PEP=I.UO
  AND NVL(O.CLAVE_PROMOCION,'#')=NVL(I.CLAVE_PROMOCION,'#')
  AND O.NOMBRE_PROMOCION=I.NOMBRE_PROMOCION
  AND O.FECHA_INICIO=I.FECHA_INICIO
  AND O.FECHA_FIN=I.FECHA_FIN
  AND O.CORTE='CENTRO'
  UNION
  SELECT DISTINCT
  I.ID,
  P.C_PEP,
  NVL(O.CLAVE_PROMOCION,'#') AS CLAVE_PROMOCION,
  O.NOMBRE_PROMOCION,
  O.CORTE,
  O.CLAVE_CORTE,
  NVL(O.TM_CATEGORIA,'#') AS TM_CATEGORIA,
  NVL(O.TM_RETORNABILIDAD,'#') AS TM_RETORNABILIDAD,
  NVL(O.TM_EMPAQUE,'#') AS TM_EMPAQUE,
  NVL(O.TM_TAMANO,'#') AS TM_TAMANO,
  O.TM_TPV AS TM_TPV,
  O.FECHA_INICIO,
  O.FECHA_FIN,
  O.SKU_VENTA,
  NVL(O.CANAL,'#') AS CANAL,
  O.CF,
  O.CU,
  O.CFC,
  0 AS PIEZAS,
  0 AS C_ORO_TRA,
  0 AS C_PLATA_TRA,
  0 AS C_BRONCE_TRA,
  0 AS C_TRA,
  0 AS COB_ORO_TRA,
  0 AS COB_PLATA_TRA,
  0 AS COB_BRONCE_TRA,
  0 AS COB_TRA,
  0 AS C_ORO_ESP,
  0 AS C_PLATA_ESP,
  0 AS C_BRONCE_ESP,
  0 AS C_ESP,
  0 AS COB_ORO_ESP,
  0 AS COB_PLATA_ESP,
  0 AS COB_BRONCE_ESP,
  0 AS COB_ESP,
  0 AS REDENCION,
  0 AS DESCUENTOS,
  0 AS GEN_1,
  0 AS GEN_2,
  0 AS GEN_3,
  0 AS GEN_4,
  0 AS GEN_5,
  0 AS GEN_6,
  0 AS GEN_7,
  0 AS GEN_8,
  0 AS GEN_9,
  0 AS GEN_10,
  I.CF AS FC_CONV,
  I.PIEZAS AS PIEZAS_CONV
  FROM MKT_ST_PS_OBJETIVO O, MKT_ST_GEOGRAFIA_PEP P, MKT_ST_PS_FILTRO_ID I
  WHERE --O.CLAVE_CORTE IN ('MJCO','MJHE')
   I.TIPO_ENTRADA='ID'
  AND O.SKU_VENTA IS NULL
  AND P.C_REGION=O.CLAVE_CORTE
  AND P.C_PEP=I.UO
  AND NVL(O.CLAVE_PROMOCION,'#')=NVL(I.CLAVE_PROMOCION,'#')
  AND O.NOMBRE_PROMOCION=I.NOMBRE_PROMOCION
  AND O.FECHA_INICIO=I.FECHA_INICIO
  AND O.FECHA_FIN=I.FECHA_FIN
  AND O.CORTE='REGION'
  UNION 
  SELECT DISTINCT
  I.ID,
  P.C_PEP,
  O.CLAVE_PROMOCION,
  O.NOMBRE_PROMOCION,
  O.CORTE,
  O.CLAVE_CORTE,
  NVL(O.TM_CATEGORIA,'#') AS TM_CATEGORIA,
  NVL(O.TM_RETORNABILIDAD,'#') AS TM_RETORNABILIDAD,
  NVL(O.TM_EMPAQUE,'#') AS TM_EMPAQUE,
  NVL(O.TM_TAMANO,'#') AS TM_TAMANO,
  O.TM_TPV AS TM_TPV,
  O.FECHA_INICIO,
  O.FECHA_FIN,
  O.SKU_VENTA,
  NVL(O.CANAL,'#') AS CANAL,
  O.CF,
  O.CU,
  O.CFC,
  0 AS PIEZAS,
  0 AS C_ORO_TRA,
  0 AS C_PLATA_TRA,
  0 AS C_BRONCE_TRA,
  0 AS C_TRA,
  0 AS COB_ORO_TRA,
  0 AS COB_PLATA_TRA,
  0 AS COB_BRONCE_TRA,
  0 AS COB_TRA,
  0 AS C_ORO_ESP,
  0 AS C_PLATA_ESP,
  0 AS C_BRONCE_ESP,
  0 AS C_ESP,
  0 AS COB_ORO_ESP,
  0 AS COB_PLATA_ESP,
  0 AS COB_BRONCE_ESP,
  0 AS COB_ESP,
  0 AS REDENCION,
  0 AS DESCUENTOS,
  0 AS GEN_1,
  0 AS GEN_2,
  0 AS GEN_3,
  0 AS GEN_4,
  0 AS GEN_5,
  0 AS GEN_6,
  0 AS GEN_7,
  0 AS GEN_8,
  0 AS GEN_9,
  0 AS GEN_10,
  I.CF AS FC_CONV,
  I.PIEZAS AS PIEZAS_CONV
  FROM MKT_ST_PS_OBJETIVO O, MKT_ST_GEOGRAFIA_PEP P, MKT_ST_PS_FILTRO_ID I
  WHERE --O.CLAVE_CORTE IN ('MJCO','MJHE')
  I.TIPO_ENTRADA='ID'
  AND O.SKU_VENTA IS NULL
  AND P.C_ESTADO=O.CLAVE_CORTE
  AND P.C_PEP=I.UO
  AND NVL(O.CLAVE_PROMOCION,'#')=NVL(I.CLAVE_PROMOCION,'#')
  AND O.NOMBRE_PROMOCION=I.NOMBRE_PROMOCION
  AND O.FECHA_INICIO=I.FECHA_INICIO
  AND O.FECHA_FIN=I.FECHA_FIN
  AND O.CORTE='ESTADO'
 );
COMMIT;
-- UPDATE A NULL DE TODOS LOS INDICADORES DE LA TABLA TEMPORAL

UPDATE MKT_PS_ETL_PEP_PROMO SET
CF=NULL,
CU=NULL,
CFC=NULL,
PIEZAS=NULL,
C_ORO_TRA=NULL,
C_PLATA_TRA=NULL,
C_BRONCE_TRA=NULL,
C_TRA=NULL,
COB_ORO_TRA=NULL,
COB_PLATA_TRA=NULL,
COB_BRONCE_TRA=NULL,
COB_TRA=NULL,
C_ORO_ESP=NULL,
C_PLATA_ESP=NULL,
C_BRONCE_ESP=NULL,
C_ESP=NULL,
COB_ORO_ESP=NULL,
COB_PLATA_ESP=NULL,
COB_BRONCE_ESP=NULL,
COB_ESP=NULL,
REDENCION=NULL,
DESCUENTOS=NULL,
GEN_1=NULL,
GEN_2=NULL,
GEN_3=NULL,
GEN_4=NULL,
GEN_5=NULL,
GEN_6=NULL,
GEN_7=NULL,
GEN_8=NULL,
GEN_9=NULL,
GEN_10=NULL;

COMMIT;


-- CURSOR PARA UPDATE DE OBJETIVOS 

DECLARE 

CURSOR C1 IS SELECT DISTINCT
NVL(CLAVE_PROMOCION,'#') AS CLAVE_PROMOCION,
NOMBRE_PROMOCION,
CLAVE_CORTE, 
NVL(TM_CATEGORIA,'#') AS TM_CATEGORIA,  
NVL(TM_RETORNABILIDAD,'#') AS TM_RETORNABILIDAD, 
NVL(TM_EMPAQUE,'#') AS TM_EMPAQUE, 
NVL(TM_TAMANO,'#') AS TM_TAMANO, 
NVL(TM_TPV,'#') AS TM_TPV, 
FECHA_INICIO,
FECHA_FIN,
NVL(CANAL,'#') AS CANAL
FROM MKT_ST_PS_OBJETIVO;


 
BEGIN FOR ITEM IN C1
LOOP 

--INDICADOR CF
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.CF=
(SELECT A.CF FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR CU


UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.CU=
(SELECT A.CU FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR CFC
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.CFC=
(SELECT A.CFC FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR PIEZAS
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.PIEZAS=
(SELECT A.PIEZAS FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR CLIENTES ORO TRADICIONAL
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.C_ORO_TRA=
(SELECT A.C_ORO_TRA FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR CLIENTES PLATA TRADICIONAL
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.C_PLATA_TRA=
(SELECT A.C_PLATA_TRA FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR CLIENTES BRONCE TRADICIONAL
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.C_BRONCE_TRA=
(SELECT A.C_BRONCE_TRA FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR CLIENTES TRADICIONAL
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.C_TRA=
(SELECT A.C_TRA FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR COBERTURA ORO TRADICIONAL
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.COB_ORO_TRA=
(SELECT A.COB_ORO_TRA FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR COBERTURA PLATA TRADICIONAL
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.COB_PLATA_TRA=
(SELECT A.COB_PLATA_TRA FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR COBERTURA BRONCE TRADICIONAL
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.COB_BRONCE_TRA=
(SELECT A.COB_BRONCE_TRA FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR COBERTURA TRADICIONAL
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.COB_TRA=
(SELECT A.COB_TRA FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	




-- INDICADOR CLIENTES ORO ESPECIALIZADA
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.C_ORO_ESP=
(SELECT A.C_ORO_ESP FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR CLIENTES PLATA ESPECIALIZADA
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.C_PLATA_ESP=
(SELECT A.C_PLATA_ESP FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR CLIENTES BRONCE ESPECIALIZADA
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.C_BRONCE_ESP=
(SELECT A.C_BRONCE_ESP FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR CLIENTES ESPECIALIZADA
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.C_ESP=
(SELECT A.C_ESP FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR COBERTURA ORO ESPECIALIZADA
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.COB_ORO_ESP=
(SELECT A.COB_ORO_ESP FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	




-- INDICADOR COBERTURA PLATA ESPECIALIZADA
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.COB_PLATA_ESP=
(SELECT A.COB_PLATA_ESP FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR COBERTURA BRONCE ESPECIALIZADA
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.COB_BRONCE_ESP=
(SELECT A.COB_BRONCE_ESP FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR COBERTURA ESPECIALIZADA
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.COB_ESP=
(SELECT A.COB_ESP FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-------------------------
-------------------------
-- INDICADOR REDENCION
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.REDENCION=
(SELECT A.REDENCION FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	

-- INDICADOR DESCUENTOS
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.DESCUENTOS=
(SELECT A.DESCUENTOS FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	

-- INDICADOR GENERICO 1
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_1=
(SELECT A.GEN_1 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	




-- INDICADOR GENERICO 2
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_2=
(SELECT A.GEN_2 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR GENERICO 3
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_3=
(SELECT A.GEN_3 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR GENERICO 4
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_4=
(SELECT A.GEN_4 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR GENERICO 5
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_5=
(SELECT A.GEN_5 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR GENERICO 6
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_6=
(SELECT A.GEN_6 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR GENERICO 7
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_7=
(SELECT A.GEN_7 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	



-- INDICADOR GENERICO 8
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_8=
(SELECT A.GEN_8 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR GENERICO 9
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_9=
(SELECT A.GEN_9 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	


-- INDICADOR GENERICO 10
UPDATE MKT_PS_ETL_PEP_PROMO B 
SET B.GEN_10=
(SELECT A.GEN_10 FROM MKT_ST_PS_OBJETIVO A 
WHERE A.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND A.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND A.CORTE=B.CORTE 
AND NVL(A.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(A.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(A.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(A.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND A.FECHA_INICIO=B.FECHA_INICIO
AND A.FECHA_FIN=B.FECHA_FIN
AND A.CANAL=B.CANAL
AND A.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(A.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
)
WHERE ITEM.CLAVE_PROMOCION=B.CLAVE_PROMOCION
AND ITEM.NOMBRE_PROMOCION=B.NOMBRE_PROMOCION
AND NVL(ITEM.TM_CATEGORIA,'#')=NVL(B.TM_CATEGORIA,'#') 
AND NVL(ITEM.TM_RETORNABILIDAD,'#')=NVL(B.TM_RETORNABILIDAD,'#') 
AND NVL(ITEM.TM_EMPAQUE,'#')=NVL(B.TM_EMPAQUE,'#')
AND NVL(ITEM.TM_TAMANO,'#')=NVL(B.TM_TAMANO,'#') 
AND ITEM.FECHA_INICIO=B.FECHA_INICIO
AND ITEM.FECHA_FIN=B.FECHA_FIN
AND ITEM.CANAL=B.CANAL
AND ITEM.CLAVE_CORTE=B.CLAVE_CORTE
AND NVL(ITEM.TM_TPV,'#')=NVL(B.TM_TPV,'#')
AND ROWNUM = 1
;	






COMMIT;
END LOOP;
END;

/

COMMIT;



 -- FACT TABLE  VENTA ELEMENTO PEP

--DROP TABLE MKT_PS_TEMP1;
INSERT INTO MKT_PS_FACT_VTA_PEP
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  A.FC_CONV AS CF_CONV,
  A.PIEZAS_CONV AS PIEZAS_CONV,
  TO_NUMBER(0) AS CF_REAL,
  A.GEN_1,
  A.GEN_2,
  A.GEN_3,
  A.GEN_4,
  A.GEN_5,
  A.GEN_6,
  A.GEN_7,
  A.GEN_8,
  A.GEN_9,
  A.GEN_10
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND A.TM_TPV IS NULL
;

COMMIT;
-- REVISAR UNIDADES OPERATIVAS QUE EXISTEN EN MAS DE UN CENTRO POSIBLE RE UPDATE



------------------------------------------------------------------------------------------------------------------------------
--TABLA POR REGION 

--DROP TABLE MKT_PS_TEMP1;
INSERT INTO MKT_PS_AGG_VTA_PEP_REG
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  A.FC_CONV AS CF_CONV,
  A.PIEZAS_CONV AS PIEZAS_CONV,
  TO_NUMBER(0) AS CF_REAL,
  A.GEN_1,
  A.GEN_2,
  A.GEN_3,
  A.GEN_4,
  A.GEN_5,
  A.GEN_6,
  A.GEN_7,
  A.GEN_8,
  A.GEN_9,
  A.GEN_10
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND A.TM_TPV IS NULL --)
;
COMMIT;


-- LLAVES PARA AGREGADO POR REGION
CREATE TABLE MKT_PS_TEMP_12 AS(
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_FACT_VTA_PEP
MINUS
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_VTA_PEP_REG)
;
COMMIT;



--SELECT * FROM MKT_PS_TEMP_12;

INSERT INTO MKT_PS_AGG_VTA_PEP_REG
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_REGION,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_PEP,
  SUM(MD_CF_OBJ),
  SUM(MD_CFC_OBJ),
  SUM(MD_CU_OBJ),
  SUM(MD_PIEZAS_OBJ),
  SUM(MD_REDENCION),
  SUM(MD_DESCUENTO),
  SUM(MD_CF_CONV),
  SUM(MD_PIEZAS_CONV),
  SUM(MD_CF_REAL),
  SUM(MD_GENERICO_1),
  SUM(MD_GENERICO_2),
  SUM(MD_GENERICO_3),
  SUM(MD_GENERICO_4),
  SUM(MD_GENERICO_5),
  SUM(MD_GENERICO_6),
  SUM(MD_GENERICO_7),
  SUM(MD_GENERICO_8),
  SUM(MD_GENERICO_9),
  SUM(MD_GENERICO_10)
FROM MKT_PS_FACT_VTA_PEP F, MKT_PS_TEMP_12 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_REGION=T.FK_REGION AND 
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_PEP=T.FK_PEP group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_REGION, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO,
F.FK_CLAVE_PROMO, F.FK_PROMOCION,  F.FK_PEP;

COMMIT;

-- TABLAS A NIVEL ESTADO 



INSERT INTO MKT_PS_AGG_VTA_PEP_EDO
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  A.FC_CONV AS CF_CONV,
  A.PIEZAS_CONV AS PIEZAS_CONV,
  TO_NUMBER(0) AS CF_REAL,
  A.GEN_1,
  A.GEN_2,
  A.GEN_3,
  A.GEN_4,
  A.GEN_5,
  A.GEN_6,
  A.GEN_7,
  A.GEN_8,
  A.GEN_9,
  A.GEN_10
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND A.TM_TPV IS NULL --)
;
COMMIT;
--DROP TABLE MKT_PS_TEMP_12;
CREATE TABLE MKT_PS_TEMP_13 AS(
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_VTA_PEP_REG
MINUS
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_VTA_PEP_EDO)
;
COMMIT;



--SELECT * FROM MKT_PS_TEMP_13;
--TRUNCATE TABLE MKT_PS_AGG_VTA_PEP_EDO;
INSERT INTO MKT_PS_AGG_VTA_PEP_EDO
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_PEP,
  SUM(MD_CF_OBJ),
  SUM(MD_CFC_OBJ),
  SUM(MD_CU_OBJ),
  SUM(MD_PIEZAS_OBJ),
  SUM(MD_REDENCION),
  SUM(MD_DESCUENTO),
  SUM(MD_CF_CONV),
  SUM(MD_PIEZAS_CONV),
  SUM(MD_CF_REAL),
  SUM(MD_GENERICO_1),
  SUM(MD_GENERICO_2),
  SUM(MD_GENERICO_3),
  SUM(MD_GENERICO_4),
  SUM(MD_GENERICO_5),
  SUM(MD_GENERICO_6),
  SUM(MD_GENERICO_7),
  SUM(MD_GENERICO_8),
  SUM(MD_GENERICO_9),
  SUM(MD_GENERICO_10)
FROM MKT_PS_AGG_VTA_PEP_REG F, MKT_PS_TEMP_13 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_PEP=T.FK_PEP group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO,
F.FK_CLAVE_PROMO, F.FK_PROMOCION,  F.FK_PEP;

COMMIT;

 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 -----------------------------------------------------------------TABLAS DE HECHOS VENTAS PEP PLAN DE VISITA------------------------------- 
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------
 ------------------------------------------------------------------------------------------------------------------------------------------ 
 -- FACT TABLE 

INSERT INTO MKT_PS_FACT_VTA_PEP_PV
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
G.CENTRO AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
A.TM_TPV AS FK_PLAN_VISITA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  A.FC_CONV AS CF_CONV,
  A.PIEZAS_CONV AS PIEZAS_CONV,
  TO_NUMBER(0) AS CF_REAL
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND A.TM_TPV IS NOT NULL --)
;

COMMIT;
--127
-- REVISAR UNIDADES OPERATIVAS QUE EXISTEN EN MAS DE UN CENTRO POSIBLE RE UPDATE
--SELECT * FROM MKT_PS_FACT_VTA_PEP;


------------------------------------------------------------------------------------------------------------------------------
--TABLA POR REGION 

--DROP TABLE MKT_PS_TEMP1;
INSERT INTO MKT_PS_AGG_VTA_PEP_PV_REG
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
A.TM_TPV AS FK_PLAN_VISITA,
LPAD(A.CLAVE_PROMOCION,4,'0')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  A.FC_CONV AS CF_CONV,
  A.PIEZAS_CONV AS PIEZAS_CONV,
  TO_NUMBER(0) AS CF_REAL
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND A.TM_TPV IS NOT NULL --)
;
COMMIT;
--DROP TABLE MKT_PS_TEMP_12;
CREATE TABLE MKT_PS_TEMP_14 AS(
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_FACT_VTA_PEP_PV
MINUS
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_VTA_PEP_PV_REG)
;
COMMIT;



--TABLA DE HECHOS ELEMENTO PEP VENTA TIPO DE PLAN DE VISITA POR REGION 

INSERT INTO MKT_PS_AGG_VTA_PEP_PV_REG
SELECT DISTINCT
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_REGION,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PLAN_VISITA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_PEP,
  SUM(MD_CF_OBJ),
  SUM(MD_CFC_OBJ),
  SUM(MD_CU_OBJ),
  SUM(MD_PIEZAS_OBJ),
  SUM(MD_REDENCION),
  SUM(MD_DESCUENTO),
  SUM(MD_CF_CONV),
  SUM(MD_PIEZAS_CONV),
  SUM(MD_CF_REAL)
FROM MKT_PS_FACT_VTA_PEP_PV F, MKT_PS_TEMP_14 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_REGION=T.FK_REGION AND 
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_PEP=T.FK_PEP group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_REGION, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_PLAN_VISITA, 
F.FK_CLAVE_PROMO, F.FK_PROMOCION, F.FK_PEP;

COMMIT;

-- TABLAS A NIVEL ESTADO 



INSERT INTO MKT_PS_AGG_VTA_PEP_PV_EDO
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
A.TM_TPV AS FK_PLAN_VISITA,
LPAD(A.CLAVE_PROMOCION,4,'0')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.CF,
  A.CFC,
  A.CU,
  A.PIEZAS,
  A.REDENCION,
  A.DESCUENTOS,
  A.FC_CONV AS CF_CONV,
  A.PIEZAS_CONV AS PIEZAS_CONV,
  TO_NUMBER(0) AS CF_REAL
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND A.TM_TPV IS NOT NULL --)
;
COMMIT;


-- CREANDO LLAVES DE AGREGACION
CREATE TABLE MKT_PS_TEMP_15 AS(
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_VTA_PEP_PV_EDO
UNION
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_VTA_PEP_PV_REG
MINUS
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PLAN_VISITA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_VTA_PEP_PV_EDO)
;
COMMIT;



--SELECT * FROM MKT_PS_TEMP_13;

INSERT INTO MKT_PS_AGG_VTA_PEP_PV_EDO
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PLAN_VISITA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_PEP,
  SUM(MD_CF_OBJ),
  SUM(MD_CFC_OBJ),
  SUM(MD_CU_OBJ),
  SUM(MD_PIEZAS_OBJ),
  SUM(MD_REDENCION),
  SUM(MD_DESCUENTO),
  SUM(MD_CF_CONV),
  SUM(MD_PIEZAS_CONV),
  SUM(MD_CF_REAL)
FROM MKT_PS_AGG_VTA_PEP_PV_REG F, MKT_PS_TEMP_15 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_PEP=T.FK_PEP group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_CANAL_RM1, F.FK_CATEGORIA, 
F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_CLAVE_PROMO, F.FK_PLAN_VISITA, 
F.FK_PEP, F.FK_PROMOCION;

COMMIT;


-------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------- TABLAS DE HECHOS COBERTURAS---------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------
-- FACT TABLE 
-- MOD 2

INSERT INTO MKT_PS_FACT_COB_SKU
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_TRA AS CLIENTES,
A.COB_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ESP AS CLIENTES,
A.COB_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;

COMMIT;
 
 
--- TABLA AGREGADA POR REGION ZONA 

INSERT INTO MKT_PS_AGG_COB_SKU_REG
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_TRA AS CLIENTES,
A.COB_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ESP AS CLIENTES,
A.COB_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE 
)WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;

COMMIT;

--MOD3
CREATE TABLE MKT_PS_TEMP_9 AS(
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_FACT_COB_SKU
MINUS
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_COB_SKU_REG)
;
COMMIT;


---insertando registros agregados

INSERT INTO MKT_PS_AGG_COB_SKU_REG
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_REGION,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PREVENTA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_SKU,
  SUM(MD_CLIENTES),
  SUM(MD_COBERTURA)
FROM MKT_PS_FACT_COB_GEC_SKU F, MKT_PS_TEMP_9 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_REGION=T.FK_REGION AND 
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_PREVENTA=T.FK_PREVENTA AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_SKU=T.FK_SKU group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_REGION, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_PREVENTA, 
F.FK_CLAVE_PROMO, F.FK_PROMOCION, F.FK_SKU;

COMMIT;

--------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
--- TABLA AGREGADA POR ESTADO

INSERT INTO MKT_PS_AGG_COB_SKU_EDO
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_TRA AS CLIENTES,
A.COB_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ESP AS CLIENTES,
A.COB_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE 
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;

COMMIT;


CREATE TABLE MKT_PS_TEMP_10 AS(
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_COB_SKU_REG
MINUS
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_SKU
FROM MKT_PS_AGG_COB_SKU_EDO)
;
COMMIT;


---insertando registros agregados

INSERT INTO MKT_PS_AGG_COB_SKU_EDO
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PREVENTA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_SKU,
  SUM(MD_CLIENTES),
  SUM(MD_COBERTURA)
FROM MKT_PS_AGG_COB_SKU_REG F, MKT_PS_TEMP_10 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_PREVENTA=T.FK_PREVENTA AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_SKU=T.FK_SKU group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_PREVENTA, 
F.FK_CLAVE_PROMO, F.FK_PROMOCION, F.FK_SKU;

COMMIT;



----------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------COBERTURA SKU VTA GEC----------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------

--MOD4

INSERT INTO MKT_PS_FACT_COB_GEC_SKU
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ORO_TRA AS CLIENTES,
A.COB_ORO_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ORO_ESP AS CLIENTES,
A.COB_ORO_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_PLATA_TRA AS CLIENTES,
A.COB_PLATA_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_PLATA_ESP AS CLIENTES,
A.COB_PLATA_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_BRONCE_TRA AS CLIENTES,
A.COB_BRONCE_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_BRONCE_ESP AS CLIENTES,
A.COB_BRONCE_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='CENTRO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.CENTRO=A.CLAVE_CORTE 
)WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;

COMMIT;


----------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------
--COBERTURA GEC POR REGION

--MOD5
INSERT INTO MKT_PS_AGG_COB_GEC_SKU_REG
SELECT * FROM(
SELECT DISTINCT 
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ORO_TRA AS CLIENTES,
A.COB_ORO_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ORO_ESP AS CLIENTES,
A.COB_ORO_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_PLATA_TRA AS CLIENTES,
A.COB_PLATA_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_PLATA_ESP AS CLIENTES,
A.COB_PLATA_ESP AS COBERTURAS
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_BRONCE_TRA AS CLIENTES,
A.COB_BRONCE_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_BRONCE_ESP AS CLIENTES,
A.COB_BRONCE_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='REGION' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ZONA_REGION=A.CLAVE_CORTE 
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL;
COMMIT;


-- detectando llaves para agregacion 
CREATE TABLE MKT_PS_TEMP_4 AS(
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_GEC,
  FK_SKU
FROM MKT_PS_FACT_COB_GEC_SKU
MINUS
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_GEC,
  FK_SKU
FROM MKT_PS_AGG_COB_GEC_SKU_REG
);
COMMIT;


---insertando registros agregados

INSERT INTO MKT_PS_AGG_COB_GEC_SKU_REG
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_REGION,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PREVENTA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_GEC,
  F.FK_SKU,
  SUM(MD_CLIENTES),
  SUM(MD_COBERTURA)
FROM MKT_PS_FACT_COB_GEC_SKU F, MKT_PS_TEMP_4 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_REGION=T.FK_REGION AND 
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_PREVENTA=T.FK_PREVENTA AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_GEC=T.FK_GEC AND
  F.FK_SKU=T.FK_SKU group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_REGION, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_PREVENTA, 
F.FK_CLAVE_PROMO, F.FK_PROMOCION, F.FK_GEC, F.FK_SKU;

COMMIT;



----------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------
--COBERTURA GEC POR ESTADO

INSERT INTO MKT_PS_AGG_COB_GEC_SKU_EDO
SELECT * FROM (
SELECT DISTINCT 
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ORO_TRA AS CLIENTES,
A.COB_ORO_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_ORO_ESP AS CLIENTES,
A.COB_ORO_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_PLATA_TRA AS CLIENTES,
A.COB_PLATA_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_PLATA_ESP AS CLIENTES,
A.COB_PLATA_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Tradicional' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_BRONCE_TRA AS CLIENTES,
A.COB_BRONCE_TRA AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE 
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE MKT_LZ_DIM_TIPO_PREVENTA.GV_PREVENTA='Especializada' AND ROWNUM<2) AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#') AS FK_CLAVE_PROMOCION,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE' ) AS FK_GEC,
LPAD(A.SKU_VENTA,18,'0') AS FK_SKU,
A.C_BRONCE_ESP AS CLIENTES,
A.COB_BRONCE_ESP AS COBERTURA
FROM MKT_ST_PS_OBJETIVO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G
WHERE SKU_VENTA IS NOT NULL AND CORTE='ESTADO' AND
P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION AND 
G.ESTADO=A.CLAVE_CORTE 
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;

COMMIT;



CREATE TABLE MKT_PS_TEMP_11 AS(
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_GEC,
  FK_SKU
FROM MKT_PS_AGG_COB_GEC_SKU_REG
MINUS
SELECT DISTINCT FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_GEC,
  FK_SKU
FROM MKT_PS_AGG_COB_GEC_SKU_EDO
);
COMMIT;



INSERT INTO MKT_PS_AGG_COB_GEC_SKU_EDO
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PREVENTA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_GEC,
  F.FK_SKU,
  SUM(MD_CLIENTES),
  SUM(MD_COBERTURA)
FROM MKT_PS_FACT_COB_GEC_SKU F, MKT_PS_TEMP_11 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_PREVENTA=T.FK_PREVENTA AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_GEC=T.FK_GEC AND
  F.FK_SKU=T.FK_SKU group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO,  F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_PREVENTA, 
F.FK_CLAVE_PROMO, F.FK_PROMOCION, F.FK_GEC, F.FK_SKU;

COMMIT;




------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------COBERTURA PEP---------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--SELECT * FROM MKT_PS_FACT_COB_PEP;
--MOD6
INSERT INTO MKT_PS_FACT_COB_PEP
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.C_TRA AS CLIENTES,
  A.COB_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.C_ESP AS CLIENTES,
  A.COB_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;

COMMIT;
--127
-- REVISAR UNIDADES OPERATIVAS QUE EXISTEN EN MAS DE UN CENTRO POSIBLE RE UPDATE
--SELECT * FROM MKT_PS_FACT_VTA_PEP;


------------------------------------------------------------------------------------------------------------------------------
--TABLA POR REGION 


INSERT INTO MKT_PS_AGG_COB_PEP_REG
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
A.C_TRA AS CLIENTES,
A.COB_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
A.C_ESP AS CLIENTE,
A.COB_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2))
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;
COMMIT;
--DROP TABLE MKT_PS_TEMP_16;
--SELECT * FROM MKT_PS_TEMP_16;
CREATE TABLE MKT_PS_TEMP_16 AS(
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_FACT_COB_PEP
MINUS
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_COB_PEP_REG)
;
COMMIT;




--SELECT * FROM MKT_PS_AGG_COB_PEP_REG;

INSERT INTO MKT_PS_AGG_COB_PEP_REG
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_REGION,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PREVENTA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_PEP,
  SUM(F.MD_CLIENTES),
  SUM(F.MD_COBERTURA)
FROM MKT_PS_FACT_COB_PEP F, MKT_PS_TEMP_16 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_REGION=T.FK_REGION AND 
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_PEP=T.FK_PEP AND
  F.FK_PREVENTA=T.FK_PREVENTA group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_REGION, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_CLAVE_PROMO, 
F.FK_PREVENTA, F.FK_PEP, F.FK_PROMOCION;

COMMIT;

-- TABLAS A NIVEL ESTADO 



INSERT INTO MKT_PS_AGG_COB_PEP_EDO
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.C_TRA AS CLIENTES,
  A.COB_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
A.ID AS FK_PEP,
  A.C_ESP AS CLIENTES,
  A.COB_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;
COMMIT;

CREATE TABLE MKT_PS_TEMP_17 AS(
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_COB_PEP_REG
MINUS
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_PEP
FROM MKT_PS_AGG_COB_PEP_EDO)
;
COMMIT;



--SELECT * FROM MKT_PS_TEMP_17;

INSERT INTO MKT_PS_AGG_COB_PEP_EDO
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PREVENTA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_PEP,
  SUM(F.MD_CLIENTES),
  SUM(F.MD_COBERTURA)
FROM MKT_PS_AGG_COB_PEP_REG F, MKT_PS_TEMP_17 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_PEP=T.FK_PEP AND
  F.FK_PREVENTA=T.FK_PREVENTA group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_CANAL_RM1, F.FK_CATEGORIA, 
F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_PREVENTA, F.FK_CLAVE_PROMO, 
F.FK_PROMOCION, F.FK_PEP;
COMMIT;


-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------COBERTURA PEP GEC---------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--SELECT * FROM MKT_PS_FACT_COB_PEP;
--SELECT * FROM MKT_GEC;
--SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO';

--MOD7
INSERT INTO MKT_PS_FACT_COB_GEC_PEP
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_ORO_TRA AS CLIENTES,
  A.COB_ORO_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_ORO_ESP AS CLIENTES,
  A.COB_ORO_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_PLATA_TRA AS CLIENTES,
  A.COB_PLATA_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_PLATA_ESP AS CLIENTES,
  A.COB_PLATA_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_BRONCE_TRA AS CLIENTES,
  A.COB_BRONCE_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
G.ZONA_REGION AS FK_REGION,
A.CLAVE_CORTE AS FK_CENTRO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_BRONCE_ESP AS CLIENTES,
  A.COB_BRONCE_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='CENTRO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.CENTRO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;

COMMIT;
--127
-- REVISAR UNIDADES OPERATIVAS QUE EXISTEN EN MAS DE UN CENTRO POSIBLE RE UPDATE
--SELECT * FROM MKT_PS_FACT_VTA_PEP;


------------------------------------------------------------------------------------------------------------------------------
--TABLA POR REGION 


INSERT INTO MKT_PS_AGG_COB_GEC_PEP_REG
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_ORO_TRA AS CLIENTES,
  A.COB_ORO_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_ORO_ESP AS CLIENTES,
  A.COB_ORO_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_PLATA_TRA AS CLIENTES,
  A.COB_PLATA_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_PLATA_ESP AS CLIENTES,
  A.COB_PLATA_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_BRONCE_TRA AS CLIENTES,
  A.COB_BRONCE_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
G.ESTADO AS FK_ESTADO,
A.CLAVE_CORTE AS FK_REGION,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_BRONCE_ESP AS CLIENTES,
  A.COB_BRONCE_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='REGION' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ZONA_REGION=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;

COMMIT;
--DROP TABLE MKT_PS_TEMP_16;
--SELECT * FROM MKT_PS_TEMP_18;
CREATE TABLE MKT_PS_TEMP_18 AS(
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_GEC,
  FK_PEP
FROM MKT_PS_FACT_COB_GEC_PEP
MINUS
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_REGION,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_GEC,
  FK_PEP
FROM MKT_PS_AGG_COB_GEC_PEP_REG)
;
COMMIT;




--SELECT * FROM MKT_PS_AGG_COB_PEP_REG;

INSERT INTO MKT_PS_AGG_COB_GEC_PEP_REG
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_REGION,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PREVENTA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_GEC,
  F.FK_PEP,
  SUM(F.MD_CLIENTES),
  SUM(F.MD_COBERTURA)
FROM MKT_PS_FACT_COB_GEC_PEP F, MKT_PS_TEMP_18 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_REGION=T.FK_REGION AND 
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_PEP=T.FK_PEP AND
  F.FK_PREVENTA=T.FK_PREVENTA AND
  F.FK_GEC=T.FK_GEC group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_REGION, F.FK_CANAL_RM1, 
F.FK_CATEGORIA, F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_PREVENTA, 
F.FK_CLAVE_PROMO, F.FK_PROMOCION, F.FK_GEC, F.FK_PEP ;

COMMIT;

-- TABLAS A NIVEL ESTADO 



INSERT INTO MKT_PS_AGG_COB_GEC_PEP_EDO
SELECT * FROM (
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_ORO_TRA AS CLIENTES,
  A.COB_ORO_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='ORO') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_ORO_ESP AS CLIENTES,
  A.COB_ORO_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_PLATA_TRA AS CLIENTES,
  A.COB_PLATA_TRA AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='PLATA') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_PLATA_ESP AS CLIENTES,
  A.COB_PLATA_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_BRONCE_TRA CLIENTES,
  A.COB_BRONCE_TRA COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Tradicional' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
UNION
SELECT DISTINCT
TO_CHAR(A.FECHA_INICIO,'YYYY-MM-DD') AS FK_PERIODO_INICIO,
TO_CHAR(A.FECHA_FIN,'YYYY-MM-DD') AS FK_PERIODO_FIN,
A.CLAVE_CORTE AS FK_ESTADO,
A.CANAL AS FK_CANAL_RM1,
A.TM_CATEGORIA AS FK_CATEGORIA,
A.TM_RETORNABILIDAD AS FK_RETORNABILIDAD,
A.TM_EMPAQUE AS FK_EMPAQUE,
A.TM_TAMANO AS FK_TAMANO,
PR.PK_PREVENTA AS FK_PREVENTA,
NVL(A.CLAVE_PROMOCION,'#')AS FK_CLAVE_PROMO,
P.PK_PROMOCION AS FK_PROMOCION,
(SELECT CLAVE_GEC FROM MKT_GEC WHERE GEC='BRONCE') AS FK_GEC,
A.ID AS FK_PEP,
  A.C_BRONCE_ESP AS CLIENTES,
  A.COB_BRONCE_ESP AS COBERTURA
FROM MKT_PS_ETL_PEP_PROMO A,
MKT_PS_DIM_PROMOCION P,
MKT_ST_GEOGRAFIA G,
MKT_LZ_DIM_TIPO_PREVENTA PR
WHERE CORTE='ESTADO' 
AND P.GV_NOMBRE_PROMOCION=A.NOMBRE_PROMOCION
AND G.ESTADO=A.CLAVE_CORTE
AND PR.PK_PREVENTA=(SELECT PK_PREVENTA FROM MKT_LZ_DIM_TIPO_PREVENTA WHERE GV_PREVENTA='Especializada' AND ROWNUM < 2)--AND A.TM_TPV IS NULL--AND (A.C_TRA IS NOT NULL OR A.COB_TRA IS NOT NULL)
)
WHERE CLIENTES IS NOT NULL OR COBERTURA IS NOT NULL
;
COMMIT;

CREATE TABLE MKT_PS_TEMP_19 AS(
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_GEC,
  FK_PEP
FROM MKT_PS_AGG_COB_GEC_PEP_REG
MINUS
SELECT DISTINCT
  FK_PERIODO_INICIO,
  FK_PERIODO_FIN,
  FK_ESTADO,
  FK_CANAL_RM1,
  FK_CATEGORIA,
  FK_RETORNABILIDAD,
  FK_EMPAQUE,
  FK_TAMANO,
  FK_PREVENTA,
  FK_CLAVE_PROMO,
  FK_PROMOCION,
  FK_GEC,
  FK_PEP
FROM MKT_PS_AGG_COB_GEC_PEP_EDO)
;
COMMIT;



--SELECT * FROM MKT_PS_TEMP_19;

INSERT INTO MKT_PS_AGG_COB_GEC_PEP_EDO
SELECT 
  F.FK_PERIODO_INICIO,
  F.FK_PERIODO_FIN,
  F.FK_ESTADO,
  F.FK_CANAL_RM1,
  F.FK_CATEGORIA,
  F.FK_RETORNABILIDAD,
  F.FK_EMPAQUE,
  F.FK_TAMANO,
  F.FK_PREVENTA,
  F.FK_CLAVE_PROMO,
  F.FK_PROMOCION,
  F.FK_GEC,
  F.FK_PEP,
  SUM(F.MD_CLIENTES),
  SUM(F.MD_COBERTURA)
FROM MKT_PS_AGG_COB_GEC_PEP_REG F, MKT_PS_TEMP_19 T
WHERE 
  F.FK_PERIODO_INICIO=T.FK_PERIODO_INICIO AND
  F.FK_PERIODO_FIN=T.FK_PERIODO_FIN AND
  F.FK_ESTADO=T.FK_ESTADO AND
  F.FK_CANAL_RM1=T.FK_CANAL_RM1 AND
  NVL(F.FK_CATEGORIA,'#')=NVL(T.FK_CATEGORIA,'#') AND
  NVL(F.FK_RETORNABILIDAD,'#')=NVL(T.FK_RETORNABILIDAD,'#') AND 
  NVL(F.FK_EMPAQUE,'#')=NVL(T.FK_EMPAQUE,'#') AND
  NVL(F.FK_TAMANO,'#')=NVL(T.FK_TAMANO,'#') AND
  F.FK_CLAVE_PROMO=T.FK_CLAVE_PROMO AND
  F.FK_PROMOCION=T.FK_PROMOCION AND
  F.FK_PEP=T.FK_PEP AND
  F.FK_PREVENTA=T.FK_PREVENTA AND
  F.FK_GEC=T.FK_GEC group by F.FK_PERIODO_INICIO, F.FK_PERIODO_FIN, F.FK_ESTADO, F.FK_CANAL_RM1, F.FK_CATEGORIA, 
F.FK_RETORNABILIDAD, F.FK_EMPAQUE, F.FK_TAMANO, F.FK_PREVENTA, F.FK_CLAVE_PROMO, 
F.FK_PROMOCION, F.FK_GEC, F.FK_PEP;
COMMIT;






------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------MB51---------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------



-- CREACIN DE DIMENSIONES MB51

-- DIMENSIN ALMACEN

CREATE SEQUENCE MKT_PS_SEQ_ALMACEN
MINVALUE 1
START WITH 1
INCREMENT BY 1;

INSERT INTO MKT_PS_DIM_ALMACEN_MB51(
SELECT MKT_PS_SEQ_ALMACEN.NEXTVAL, ALMACEN FROM(
SELECT DISTINCT NVL(ALMACEN,'#')AS ALMACEN FROM MKT_PS_ST_MB51));

COMMIT;

-- DIMENSION USUARIO
CREATE SEQUENCE MKT_PS_SEQ_USUARIO
MINVALUE 1
START WITH 1
INCREMENT BY 1;

INSERT INTO MKT_PS_DIM_USUARIO_MB51(
SELECT MKT_PS_SEQ_USUARIO.NEXTVAL, USUARIO FROM(
SELECT DISTINCT NVL(USUARIO,'#')AS USUARIO FROM MKT_PS_ST_MB51));


-- DIMENSION MATERIAL
CREATE SEQUENCE MKT_PS_SEQ_MATERIAL
MINVALUE 1
START WITH 1
INCREMENT BY 1;

INSERT INTO MKT_PS_DIM_MATERIAL_MB51(
SELECT MKT_PS_SEQ_MATERIAL.NEXTVAL, MATERIAL, TEXTO_BREVE_MATERIAL, UM_ENTRADA FROM(
SELECT DISTINCT NVL(MATERIAL,'#')AS MATERIAL, TEXTO_BREVE_MATERIAL, UM_ENTRADA FROM MKT_PS_ST_MB51));
COMMIT;

-- DIMENSION REFERENCIA
CREATE SEQUENCE MKT_PS_SEQ_REFERENCIA
MINVALUE 1
START WITH 1
INCREMENT BY 1;

INSERT INTO MKT_PS_DIM_REFERENCIA_MB51(
SELECT MKT_PS_SEQ_REFERENCIA.NEXTVAL, REFERENCIA FROM(
SELECT DISTINCT NVL(REFERENCIA,'#')AS REFERENCIA FROM MKT_PS_ST_MB51));

COMMIT;



-- DIMENSION PEDIDO
CREATE SEQUENCE MKT_PS_SEQ_PEDIDO
MINVALUE 1
START WITH 1
INCREMENT BY 1;

INSERT INTO MKT_PS_DIM_PEDIDO_MB51(
SELECT MKT_PS_SEQ_PEDIDO.NEXTVAL, PEDIDO FROM(
SELECT DISTINCT NVL(PEDIDO,'#')AS PEDIDO FROM MKT_PS_ST_MB51));

COMMIT;


-- DIMENSION DOC MATERIAL
CREATE SEQUENCE MKT_PS_SEQ_DOC_MATERIAL
MINVALUE 1
START WITH 1
INCREMENT BY 1;

INSERT INTO MKT_PS_DIM_DOC_MATERIAL_MB51(
SELECT MKT_PS_SEQ_DOC_MATERIAL.NEXTVAL, DOCUMENTO_MATERIAL FROM(
SELECT DISTINCT NVL(DOCUMENTO_MATERIAL,'#')AS DOCUMENTO_MATERIAL FROM MKT_PS_ST_MB51));

COMMIT;





CREATE SEQUENCE MKT_PS_SEQ_MB51
MINVALUE 1
START WITH 1
INCREMENT BY 1;


INSERT INTO MKT_PS_FACT_MB51(
SELECT 
  MKT_PS_SEQ_MB51.NEXTVAL,
  --TO_CHAR(TO_DATE(S.FECHA_DOCUMENTO,'DD.MM.YYYY'),'YYYY-MM-DD') AS FK_PERIODO_DOC,
  S.FECHA_DOCUMENTO AS FK_PERIODO_DOC,
  '1',--G.ESTADO,
  '1',--G.ZONA_REGION,
  '1',--CENTRO MR
  S.CENTRO,
  U.PK_USUARIO,
  A.PK_ALMACEN,
  R.PK_REFERENCIA,
  M.PK_MATERIAL,
  DM.PK_DOC_MATERIAL,
  P.PK_PEDIDO,
  TO_NUMBER(S.MOTIVO_MOVIMIENTO),
  S.HORA,
  S.CTD_UM_ENTRADA,
  S.IMPORTE_ML  
FROM 
MKT_PS_ST_MB51 S,
MKT_PS_DIM_ALMACEN_MB51 A,
MKT_PS_DIM_USUARIO_MB51 U,
MKT_PS_DIM_MATERIAL_MB51 M,
MKT_PS_DIM_REFERENCIA_MB51 R, 
MKT_PS_DIM_PEDIDO_MB51 P,
MKT_PS_DIM_DOC_MATERIAL_MB51 DM
WHERE
A.GV_ALMACEN=NVL(S.ALMACEN,'#') AND
U.GV_USUARIO=NVL(S.USUARIO,'#') AND
R.FK_REFERENCIA=NVL(S.REFERENCIA,'#') AND
P.GV_PEDIDO=NVL(S.PEDIDO,'#') AND
M.GV_CLAVE_MATERIAL=NVL(S.MATERIAL,'#') AND
M.GV_DESC_MATERIAL=S.TEXTO_BREVE_MATERIAL AND
DM.GV_DOC_MAERIAL= S.DOCUMENTO_MATERIAL AND
M.GV_UME=S.UM_ENTRADA)
;

COMMIT;



-------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- TABLA DE HECHOS MB58
CREATE SEQUENCE MKT_PS_SEQ_MB58
MINVALUE 1
START WITH 1
INCREMENT BY 1;

INSERT INTO MKT_PS_FACT_MB58(
SELECT MKT_PS_SEQ_MB58.NEXTVAL, CENTRO, CLIENTE, MATERIAL, UNIDAD, LIBRO_UTILIZACION FROM( 
SELECT DISTINCT  CENTRO,LPAD(CLIENTE,10,'0') AS CLIENTE, LPAD(MATERIAL,18,'0') AS MATERIAL, UNIDAD, LIBRO_UTILIZACION FROM MKT_PS_ST_MB58
));

COMMIT;



 DROP TABLE MKT_PS_TEMP_ID_FILTRO;
 --DROP TABLE MKT_PS_TEMP1;
 --DROP TABLE MKT_PS_TEMP3;
 DROP TABLE MKT_PS_TEMP_4;
 DROP TABLE MKT_PS_TEMP_5;
 DROP TABLE MKT_PS_TEMP_6;
 DROP TABLE MKT_PS_TEMP_7;
 DROP TABLE MKT_PS_TEMP_8;
 DROP TABLE MKT_PS_TEMP_9;
 DROP TABLE MKT_PS_TEMP_10;
 DROP TABLE MKT_PS_TEMP_11;
 DROP TABLE MKT_PS_TEMP_12;
 DROP TABLE MKT_PS_TEMP_13;
 DROP TABLE MKT_PS_TEMP_14;
 DROP TABLE MKT_PS_TEMP_15;
 DROP TABLE MKT_PS_TEMP_16;
 DROP TABLE MKT_PS_TEMP_17;
 DROP TABLE MKT_PS_TEMP_18;
 DROP TABLE MKT_PS_TEMP_19;



DROP TABLE MKT_PS_ETL_PEP_PROMO;
COMMIT; 
 
 
 
 
/****** REGISTRO DE CONTROL ******/
UPDATE  TBLLOGREGEST SET ID_ESTATUS=2 WHERE ID_REGISTRO=(SELECT MAX(ID_REGISTRO) FROM TBLLOGREGIST WHERE ID_SCRIPT=(SELECT ID_SCRIPT FROM TBLLOGSCRIPT WHERE DESC_SCRIPT='PROMOCIONES_SAMPLINGS_PROCESO'));
COMMIT;

UPDATE TBLLOGREGIST SET FEC_FIN=current_date WHERE ID_REGISTRO=(SELECT MAX(ID_REGISTRO) FROM TBLLOGREGIST WHERE ID_SCRIPT=(SELECT ID_SCRIPT FROM TBLLOGSCRIPT WHERE DESC_SCRIPT='PROMOCIONES_SAMPLINGS_PROCESO'));
COMMIT;

 
EXIT;


 